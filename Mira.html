<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mirage Online Improved Mobile Joystick Test</title>
<style>
  body, html {
    margin: 0; padding: 0; font-family: Arial, sans-serif; background: #121212; color: #eee;
    -webkit-user-select: none;
    user-select: none;
  }
  #winTouch {
    display: grid;
    place-items: center;
    padding: 10px;
    width: 280px;
    margin: 10px auto;
    background: #222;
    border-radius: 15px;
    box-sizing: border-box;
  }

  /* Hide original joystick canvas initially */
  #cvsGamepad {
    display: none;
    background: #111;
    border-radius: 15px;
  }

  /* New joystick canvas */
  #cvsGamepadNew {
    touch-action: none;
    width: 250px;
    height: 250px;
    background: #222;
    border-radius: 20px;
  }

  /* Example HP bar container */
  #hpBar {
    width: 280px;
    height: 24px;
    background: #550000;
    border-radius: 12px;
    margin: 20px auto;
    box-sizing: border-box;
    position: relative;
    overflow: hidden;
  }
  #hpBarInner {
    height: 100%;
    background: #dd3333;
    width: 70%; /* Example HP percent */
    transition: width 0.3s ease;
  }

  /* Button to toggle controls */
  #toggleTouchBtn {
    display: block;
    margin: 20px auto;
    background: #444;
    border: none;
    color: white;
    font-size: 1rem;
    padding: 10px 20px;
    border-radius: 12px;
    cursor: pointer;
  }
</style>
</head>
<body>

<!-- HP bar example -->
<div id="hpBar"><div id="hpBarInner"></div></div>

<!-- Original joystick container -->
<div id="winTouch">
  <canvas id="cvsGamepad" width="172" height="172" style="width: 172px; height: 172px;"></canvas>
  <!-- New joystick canvas added but hidden by default -->
  <canvas id="cvsGamepadNew" width="250" height="250" style="display:none;"></canvas>
</div>

<!-- Button to simulate touch controls toggle -->
<button id="toggleTouchBtn">Use Improved Touch Controls</button>

<script>
  const originalCanvas = document.getElementById('cvsGamepad');
  const newCanvas = document.getElementById('cvsGamepadNew');
  const winTouch = document.getElementById('winTouch');
  const toggleBtn = document.getElementById('toggleTouchBtn');

  // Toggle between old and new joystick UI
  toggleBtn.addEventListener('click', () => {
    if (newCanvas.style.display === 'none') {
      // Show new joystick, hide old one
      newCanvas.style.display = 'block';
      originalCanvas.style.display = 'none';
      toggleBtn.textContent = 'Use Original Touch Controls';
      // Optionally adjust HP bar or other UI here if needed
      document.getElementById('hpBar').style.width = '180px'; // Example less stretched width
    } else {
      // Revert back
      newCanvas.style.display = 'none';
      originalCanvas.style.display = 'block';
      toggleBtn.textContent = 'Use Improved Touch Controls';
      document.getElementById('hpBar').style.width = '280px'; // Original width
    }
  });

  // ----- New Joystick Logic -----

  const ctx = newCanvas.getContext('2d');
  const maxRadius = 80;
  let dragging = false;
  let touchStartPos = null;
  let currentPos = null;

  function drawJoystick(basePos, stickPos) {
    ctx.clearRect(0, 0, newCanvas.width, newCanvas.height);

    // Draw base circle
    ctx.beginPath();
    ctx.arc(basePos.x, basePos.y, maxRadius, 0, Math.PI * 2);
    ctx.fillStyle = 'rgba(255,255,255,0.1)';
    ctx.fill();

    // Draw stick/thumb
    ctx.beginPath();
    ctx.arc(stickPos.x, stickPos.y, 30, 0, Math.PI * 2);
    ctx.fillStyle = 'rgba(255,255,255,0.4)';
    ctx.fill();
  }

  function handleMove(pos) {
    const dx = pos.x - touchStartPos.x;
    const dy = pos.y - touchStartPos.y;
    const dist = Math.sqrt(dx*dx + dy*dy);

    let clampedDx = dx;
    let clampedDy = dy;
    if (dist > maxRadius) {
      clampedDx = (dx / dist) * maxRadius;
      clampedDy = (dy / dist) * maxRadius;
    }

    const stickPos = {
      x: touchStartPos.x + clampedDx,
      y: touchStartPos.y + clampedDy
    };

    drawJoystick(touchStartPos, stickPos);

    // TODO: Add movement command handling here,
    // e.g. send movement direction to your game logic.

    // Example:
    // console.log('Move dx:', clampedDx.toFixed(2), 'dy:', clampedDy.toFixed(2));
  }

  newCanvas.addEventListener('pointerdown', (e) => {
    dragging = true;
    const rect = newCanvas.getBoundingClientRect();
    touchStartPos = { x: e.clientX - rect.left, y: e.clientY - rect.top };
    currentPos = {...touchStartPos};
    drawJoystick(touchStartPos, touchStartPos);
    newCanvas.setPointerCapture(e.pointerId);
  });

  newCanvas.addEventListener('pointermove', (e) => {
    if (!dragging) return;
    const rect = newCanvas.getBoundingClientRect();
    currentPos = { x: e.clientX - rect.left, y: e.clientY - rect.top };
    handleMove(currentPos);
  });

  newCanvas.addEventListener('pointerup', (e) => {
    dragging = false;
    ctx.clearRect(0, 0, newCanvas.width, newCanvas.height);
    touchStartPos = null;
    currentPos = null;

    // TODO: Send stop movement signal here
  });

  newCanvas.addEventListener('pointercancel', (e) => {
    dragging = false;
    ctx.clearRect(0, 0, newCanvas.width, newCanvas.height);
    touchStartPos = null;
    currentPos = null;

    // TODO: Send stop movement signal here
  });
</script>

</body>
</html>
