<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mirage Online with TotalEnhance Overlay</title>
<style>
  /* Basic reset */
  body, html {
    margin: 0; padding: 0; height: 100vh; background: #121212; overflow: hidden;
    font-family: Arial, sans-serif;
    user-select: none;
  }

  /* The game iframe fills the entire viewport */
  #gameFrame {
    width: 100vw;
    height: 100vh;
    border: none;
    display: block;
  }

  /* Overlay container, covers entire viewport, pointer events pass through except for children */
  #overlayContainer {
    position: fixed;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    pointer-events: none;
    z-index: 99999;
  }

  /* Hotbar styles */
  #canvasHotbar {
    position: fixed;
    bottom: 40px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 6px;
    padding: 6px 10px;
    background: rgba(0,0,0,0.35);
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 8px;
    backdrop-filter: blur(4px);
    pointer-events: auto;
    cursor: grab;
    user-select: none;
  }

  #canvasHotbar.locked {
    cursor: default;
  }

  #canvasHotbar .slot {
    position: relative;
    width: 42px;
    height: 42px;
    border: 1px solid rgba(255,255,255,0.25);
    border-radius: 6px;
    background: rgba(255,255,255,0.08);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    color: white;
    cursor: pointer;
    overflow: hidden;
    user-select: none;
  }

  #canvasHotbar .slot.plus {
    background: rgba(0,150,0,0.4);
    font-size: 24px;
    color: #0f0;
  }

  #canvasHotbar .slot .hotkeyLabel {
    position: absolute;
    bottom: 2px;
    right: 4px;
    font-weight: bold;
    font-size: 12px;
    color: #0f0;
    text-shadow: 0 0 3px black;
    pointer-events: none;
    z-index: 10;
  }

  #canvasHotbar .slot div[title="Change keybind"] {
    position: absolute;
    top: -6px;
    right: -2px;
    font-size: 14px;
    cursor: pointer;
    z-index: 10;
  }

  #canvasHotbar button.lock-btn {
    font-size: 13px;
    margin-left: 6px;
    cursor: pointer;
    background: none;
    border: none;
    color: #0f0;
    user-select: none;
  }

  /* Wiki buttons container */
  #wikiButtons {
    position: fixed;
    bottom: 90px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 10px;
    pointer-events: auto;
    user-select: none;
  }

  #wikiButtons button {
    background: rgba(0, 0, 0, 0.6);
    color: #0f0;
    border: 1px solid #0f0;
    padding: 6px 12px;
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
    font-size: 14px;
  }

  #wikiButtons button:hover {
    background: rgba(0, 255, 0, 0.2);
  }

  /* Wiki overlay windows */
  .wikiOverlay {
    position: fixed;
    top: 10%;
    left: 10%;
    width: 80vw;
    height: 80vh;
    background: rgba(18, 18, 18, 0.95);
    border: 2px solid #0f0;
    border-radius: 10px;
    box-shadow: 0 0 10px #0f0;
    z-index: 100000;
    display: none;
    flex-direction: column;
  }

  .wikiOverlay header {
    background: #0f0;
    color: #000;
    padding: 8px 12px;
    font-weight: bold;
    font-size: 18px;
    cursor: move;
    user-select: none;
  }

  .wikiOverlay iframe {
    flex-grow: 1;
    border: none;
    border-radius: 0 0 10px 10px;
  }

  .wikiOverlay button.closeBtn {
    position: absolute;
    top: 8px;
    right: 12px;
    background: transparent;
    border: none;
    font-size: 22px;
    font-weight: bold;
    color: #000;
    cursor: pointer;
    user-select: none;
  }

</style>
</head>
<body>

<!-- Game iframe -->
<iframe id="gameFrame" src="https://play.consty.com" allowfullscreen sandbox="allow-scripts allow-same-origin allow-forms allow-popups"></iframe>

<!-- Overlay container -->
<div id="overlayContainer">

  <!-- Canvas Hotbar -->
  <div id="canvasHotbar" title="Drag to move, click slots to assign keys">
    <!-- Slots and buttons will be added by script -->
  </div>

  <!-- Wiki buttons -->
  <div id="wikiButtons">
    <button id="btnItemWiki">Item Wiki</button>
    <button id="btnNpcWiki">NPC Wiki</button>
  </div>

  <!-- Wiki overlays -->
  <div id="itemWikiOverlay" class="wikiOverlay">
    <header>Item Wiki
      <button class="closeBtn" title="Close">&times;</button>
    </header>
    <iframe src="https://loociez.github.io/MOC-IV/itemslast.html"></iframe>
  </div>

  <div id="npcWikiOverlay" class="wikiOverlay">
    <header>NPC Wiki
      <button class="closeBtn" title="Close">&times;</button>
    </header>
    <iframe src="https://loociez.github.io/MOC-IV/npclast.html"></iframe>
  </div>

</div>

<script>
(() => {
  "use strict";

  // === HOTBAR LOGIC ===
  const HOTBAR_ID = "canvasHotbar";
  const STORAGE_KEY = "CanvasHotbarBindings";
  const LOCK_KEY = "CanvasHotbarLocked";
  const POS_KEY = "CanvasHotbarPosition";

  const INITIAL_KEYS = new Set(["C", "V", "B"]);

  const bar = document.getElementById(HOTBAR_ID);

  // Load saved bindings
  let saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
  let locked = localStorage.getItem(LOCK_KEY) === "true";
  let awaitingAssignmentFor = null;

  // Restore position
  const savedPos = JSON.parse(localStorage.getItem(POS_KEY) || "null");
  if (savedPos) {
    bar.style.left = savedPos.left + "px";
    bar.style.top = savedPos.top + "px";
    bar.style.bottom = "auto";
    bar.style.transform = "none";
  } else {
    // default position style is bottom:40px and center horizontally
    bar.style.bottom = "40px";
    bar.style.left = "50%";
    bar.style.transform = "translateX(-50%)";
  }

  if (locked) {
    bar.classList.add("locked");
  } else {
    bar.classList.remove("locked");
  }

  // Dragging variables
  let dragging = false, offX = 0, offY = 0;

  bar.addEventListener("mousedown", (e) => {
    if (locked) return;
    if (e.target.classList.contains("slot") ||
        e.target.classList.contains("hotkeyLabel") ||
        e.target.innerText === "âš™ï¸" ||
        e.target.innerText === "+") return;

    dragging = true;
    offX = e.clientX - bar.offsetLeft;
    offY = e.clientY - bar.offsetTop;
    bar.style.cursor = "grabbing";
    e.preventDefault();
  });

  document.addEventListener("mouseup", () => {
    if (dragging) {
      dragging = false;
      bar.style.cursor = "grab";

      localStorage.setItem(POS_KEY, JSON.stringify({
        left: bar.offsetLeft,
        top: bar.offsetTop
      }));
    }
  });

  document.addEventListener("mousemove", (e) => {
    if (!dragging) return;
    bar.style.left = (e.clientX - offX) + "px";
    bar.style.top = (e.clientY - offY) + "px";
    bar.style.bottom = "auto";
    bar.style.transform = "none";
  });

  // Save bindings helper
  function saveBindings() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(saved));
  }

  // Create slot element
  function createSlot(initialKey, isPlus = false) {
    const div = document.createElement("div");
    div.classList.add("slot");
    if (isPlus) div.classList.add("plus");
    div.style.position = "relative";

    if (isPlus) {
      div.innerText = "+";
      div.title = "Add new slot";
      div.addEventListener("click", () => {
        if (locked) return;
        const used = new Set(Object.keys(saved));
        let newKey = null;
        for (let i = 65; i <= 90; i++) {
          const ch = String.fromCharCode(i);
          if (!used.has(ch)) {
            newKey = ch;
            break;
          }
        }
        if (!newKey) {
          alert("No more keys available.");
          return;
        }
        saved[newKey] = -1;
        saveBindings();
        const slot = createSlot(newKey);
        bar.insertBefore(slot, div);
        console.log("Added slot:", newKey);
      });
      return div;
    }

    // Normal slot key label
    const keyLabel = document.createElement("div");
    keyLabel.innerText = initialKey;
    keyLabel.classList.add("hotkeyLabel");
    div.appendChild(keyLabel);

    // Settings cog
    const cog = document.createElement("div");
    cog.innerText = "âš™ï¸";
    cog.title = "Change keybind";
    cog.style.position = "absolute";
    cog.style.top = "-6px";
    cog.style.right = "-2px";
    cog.style.fontSize = "14px";
    cog.style.cursor = "pointer";
    cog.style.zIndex = "10";
    div.appendChild(cog);

    cog.addEventListener("click", (e) => {
      e.stopPropagation();
      if (locked) return;
      div.style.outline = "2px solid yellow";

      const listener = (ev) => {
        ev.preventDefault();
        const newKey = ("" + ev.key).toUpperCase();

        // De-dupe
        for (const k in saved) {
          if (k === newKey) delete saved[k];
        }

        const oldKey = keyLabel.innerText;
        saved[newKey] = saved[oldKey] ?? -1;
        delete saved[oldKey];

        saveBindings();
        keyLabel.innerText = newKey;

        document.removeEventListener("keydown", listener, true);
        div.style.outline = "";
      };

      document.addEventListener("keydown", listener, true);
    });

    // Right-click delete for non-initial keys
    div.addEventListener("mousedown", (e) => {
      if (locked) return;
      if (e.button === 2) {
        e.preventDefault();
        const key = keyLabel.innerText;
        if (INITIAL_KEYS.has(key)) return;
        delete saved[key];
        saveBindings();
        div.remove();
      }
    });

    // Click to assign slot (just visual here)
    div.addEventListener("click", (ev) => {
      if (locked) return;
      if (ev.target.innerText === "âš™ï¸") return;
      const key = keyLabel.innerText;
      awaitingAssignmentFor = key;
      div.style.outline = "2px solid gold";
      setTimeout(() => div.style.outline = "", 600);
      alert(`Key "${key}" clicked.\n\nNOTE: Due to cross-origin iframe restrictions, this hotbar is visual only and cannot trigger game actions directly.`);
    });

    // Prevent context menu on right click except locked keys
    div.addEventListener("contextmenu", (e) => {
      if (locked) return;
      const key = keyLabel.innerText;
      if (!INITIAL_KEYS.has(key)) e.preventDefault();
    });

    return div;
  }

  // Build hotbar slots from saved keys or defaults
  const keys = Object.keys(saved).length ? Object.keys(saved) : ["C", "V", "B"];
  keys.forEach(k => bar.appendChild(createSlot(k)));

  // Add plus slot to add new slots
  const addSlotBtn = createSlot("+", true);
  bar.appendChild(addSlotBtn);

  // Lock button
  const lockBtn = document.createElement("button");
  lockBtn.classList.add("lock-btn");
  lockBtn.innerText = locked ? "ðŸ”’" : "ðŸ”“";
  lockBtn.title = "Lock/unlock hotbar";
  lockBtn.onclick = () => {
    locked = !locked;
    localStorage.setItem(LOCK_KEY, locked);
    lockBtn.innerText = locked ? "ðŸ”’" : "ðŸ”“";
    if (locked) {
      bar.classList.add("locked");
      bar.style.cursor = "default";
      document.querySelectorAll(`#${HOTBAR_ID} .slot`).forEach(s => s.style.cursor = "default");
    } else {
      bar.classList.remove("locked");
      bar.style.cursor = "grab";
      document.querySelectorAll(`#${HOTBAR_ID} .slot`).forEach(s => s.style.cursor = "pointer");
    }
  };
  bar.appendChild(lockBtn);

  // Prevent right-click context menu on hotbar globally to enable right click deletion
  bar.addEventListener("contextmenu", (e) => {
    if (!locked) e.preventDefault();
  });

  // === WIKI OVERLAYS LOGIC ===
  const itemWikiBtn = document.getElementById("btnItemWiki");
  const npcWikiBtn = document.getElementById("btnNpcWiki");
  const itemWikiOverlay = document.getElementById("itemWikiOverlay");
  const npcWikiOverlay = document.getElementById("npcWikiOverlay");

  function makeDraggable(el, handle) {
    let isDragging = false;
    let startX, startY, origX, origY;

    handle.style.cursor = "move";

    handle.addEventListener("mousedown", (e) => {
      e.preventDefault();
      isDragging = true;
      startX = e.clientX;
      startY = e.clientY;
      origX = el.offsetLeft;
      origY = el.offsetTop;
      document.body.style.userSelect = "none";
    });

    document.addEventListener("mouseup", () => {
      if (isDragging) {
        isDragging = false;
        document.body.style.userSelect = "";
      }
    });

    document.addEventListener("mousemove", (e) => {
      if (!isDragging) return;
      const dx = e.clientX - startX;
      const dy = e.clientY - startY;
      el.style.left = (origX + dx) + "px";
      el.style.top = (origY + dy) + "px";
    });
  }

  // Show / hide logic
  itemWikiBtn.addEventListener("click", () => {
    if (itemWikiOverlay.style.display === "flex") {
      itemWikiOverlay.style.display = "none";
    } else {
      itemWikiOverlay.style.display = "flex";
    }
  });

  npcWikiBtn.addEventListener("click", () => {
    if (npcWikiOverlay.style.display === "flex") {
      npcWikiOverlay.style.display = "none";
    } else {
      npcWikiOverlay.style.display = "flex";
    }
  });

  // Close buttons for overlays
  document.querySelectorAll(".wikiOverlay .closeBtn").forEach(btn => {
    btn.addEventListener("click", (e) => {
      e.target.closest(".wikiOverlay").style.display = "none";
    });
  });

  // Make overlays draggable
  makeDraggable(itemWikiOverlay, itemWikiOverlay.querySelector("header"));
  makeDraggable(npcWikiOverlay, npcWikiOverlay.querySelector("header"));

  console.log("%cOverlay page loaded with hotbar and wiki overlays.", "color:#0f0");

})();
</script>

</body>
</html>
