<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MOC Global Chat Viewer</title>

<style>
body {
  font-family: Arial, sans-serif;
  background: #1a1a1a;
  color: #eee;
  margin: 0;
}

#chatView {
  max-width: 800px;
  margin: 1em auto;
}

#chatLog {
  background: #222;
  padding: 1em;
  height: 500px;
  overflow-y: auto;
  border-radius: 6px;
}

.chat-message {
  margin-bottom: 6px;
  line-height: 1.3;
}

/* ✨ NEW MESSAGE ANIMATION */
.chat-message.new {
  animation: newMessage 1.2s ease-out;
}

@keyframes newMessage {
  0% {
    background: rgba(255, 0, 255, 0.15);
    transform: translateY(4px);
  }
  100% {
    background: transparent;
    transform: translateY(0);
  }
}

.chat-time { color: #888; }
.chat-user { color: #00ff00; }
.chat-text { color: #ff00ff; }
</style>
</head>

<body>

<div id="chatView">
  <h2>Mirage Online Classic — Global Chat</h2>
  <div id="chatLog">Connecting…</div>
</div>

<script>
(() => {

  /* ============ CONFIG ============ */

  const CHAT_API_URL = 'https://moc.marocodes.eu/api/messages';
  const API_TOKEN = 'f684f5c2474a579a37e6747e92e3b8a4';
  const POLL_INTERVAL = 2000;

  /* =============================== */

  const chatLog = document.getElementById('chatLog');
  let lastMessageKey = null;

  function escapeHtml(value) {
    if (value === undefined || value === null) return '';
    return String(value).replace(/[&<>"']/g, m => ({
      '&':'&amp;',
      '<':'&lt;',
      '>':'&gt;',
      '"':'&quot;',
      "'":'&#39;'
    })[m]);
  }

  function getMessageKey(m) {
    return `${m.time ?? ''}|${m.user ?? m.username ?? ''}|${m.message ?? m.text ?? ''}`;
  }

  async function fetchChat() {
    try {
      const res = await fetch(CHAT_API_URL, {
        headers: {
          'Authorization': `Bearer ${API_TOKEN}`
        }
      });

      if (!res.ok) throw new Error('API error');

      const messages = await res.json();
      if (!Array.isArray(messages)) return;

      render(messages.slice().reverse());

    } catch (err) {
      chatLog.innerHTML = '<em>Failed to load chat…</em>';
      console.error(err);
    }
  }

  function render(messages) {
    const newLastKey = getMessageKey(messages[messages.length - 1]);

    chatLog.innerHTML = messages.map(m => {
      const key = getMessageKey(m);
      const isNew = lastMessageKey && key === newLastKey && key !== lastMessageKey;

      const time = escapeHtml(m.time ?? m.timestamp ?? '');
      const user = escapeHtml(m.user ?? m.username ?? 'Unknown');
      const text = escapeHtml(m.message ?? m.text ?? '');

      return `
        <div class="chat-message ${isNew ? 'new' : ''}">
          <span class="chat-time">[${time}]</span>
          <span class="chat-user">${user}:</span>
          <span class="chat-text">${text}</span>
        </div>
      `;
    }).join('');

    lastMessageKey = newLastKey;
    chatLog.scrollTop = chatLog.scrollHeight;
  }

  fetchChat();
  setInterval(fetchChat, POLL_INTERVAL);

})();
</script>

</body>
</html>
