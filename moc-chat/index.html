<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MOC Global Chat Viewer</title>
<style>
  body { font-family: Arial, sans-serif; background: #1a1a1a; color: #eee; margin: 0; padding: 0; }
  #login { max-width: 300px; margin: 5em auto; }
  #chatView { max-width: 600px; margin: 1em auto; display: none; }
  #chatLog { background: #222; padding: 1em; height: 400px; overflow-y: auto; border-radius: 5px; }
  #sendStatus { margin-top: 1em; }
  button { padding: 10px; background: #ff00ff; border: none; color: white; border-radius: 5px; cursor: pointer; }
  input { padding: 10px; width: 100%; margin-bottom: 1em; border-radius: 5px; border: none; }
  .chat-message { margin-bottom: 0.5em; }
  .chat-time { color: #888; margin-right: 0.5em; }
  .chat-user { color: #00ff00; margin-right: 0.3em; }
  .chat-text { color: #ff00ff; }
</style>
</head>
<body>

<div id="login">
  <h2>MOC Chat Login</h2>
  <input type="password" id="passwordInput" placeholder="Enter password" />
  <button id="loginBtn">Login</button>
  <p id="loginError" style="color: red; display:none;">Wrong password</p>
</div>

<div id="chatView">
  <h2>Global Chat Viewer</h2>
  <div id="chatLog"></div>
</div>

<script>
(() => {
  const BACKEND_URL = 'http://localhost:3000'; // Replace with your backend URL when deployed
  const correctPassword = 'mocsecret';

  const loginDiv = document.getElementById('login');
  const chatView = document.getElementById('chatView');
  const loginBtn = document.getElementById('loginBtn');
  const passwordInput = document.getElementById('passwordInput');
  const loginError = document.getElementById('loginError');
  const chatLogDiv = document.getElementById('chatLog');

  loginBtn.onclick = () => {
    if (passwordInput.value === correctPassword) {
      loginDiv.style.display = 'none';
      chatView.style.display = 'block';
      startChatPolling();
    } else {
      loginError.style.display = 'block';
    }
  };

  let chatMessages = [];

  function escapeHtml(text) {
    return text.replace(/[&<>"']/g, m => ({
      '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
    })[m]);
  }

  function renderChat() {
    chatLogDiv.innerHTML = chatMessages.map(m => {
      return `<div class="chat-message">
        <span class="chat-time">[${m.time}]</span>
        <span class="chat-user">${escapeHtml(m.user)}:</span>
        <span class="chat-text">${escapeHtml(m.message)}</span>
      </div>`;
    }).join('');
    chatLogDiv.scrollTop = chatLogDiv.scrollHeight;
  }

  async function fetchChat() {
    try {
      const res = await fetch(`${BACKEND_URL}/api/chat`);
      if (!res.ok) throw new Error('Fetch failed');
      const data = await res.json();
      chatMessages = data;
      renderChat();
    } catch (e) {
      console.error('Error fetching chat:', e);
    }
  }

  function startChatPolling() {
    fetchChat();
    setInterval(fetchChat, 2000);
  }
})();
</script>

</body>
</html>
