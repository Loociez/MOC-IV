<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>MOC Global Chat Viewer</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
  body {
  font-family: 'Press Start 2P', 'Segoe UI Emoji', 'Noto Color Emoji', monospace, Arial, sans-serif;
  background: radial-gradient(circle at top left, #12002b, #000000);
  color: #eee;
  margin: 0;
  user-select: none;
}

#chatView {
  max-width: 900px;
  margin: 2em auto;
  padding: 1em;
  background: rgba(30, 0, 50, 0.6);
  border-radius: 12px;
  box-shadow: 0 0 15px #ff00ff88;
  backdrop-filter: blur(8px);
  border: 1px solid #ff00ff55;
}

#chatLog {
  background: rgba(10, 0, 20, 0.8);
  padding: 1em;
  height: 520px;
  overflow-y: auto;
  border-radius: 10px;
  box-shadow: inset 0 0 8px #ff00ff44;
  scrollbar-width: thin;
  scrollbar-color: #ff00ffaa transparent;
  font-size: 14px;
}

#chatLog::-webkit-scrollbar {
  width: 8px;
}
#chatLog::-webkit-scrollbar-thumb {
  background: #ff00ffaa;
  border-radius: 10px;
  box-shadow: 0 0 8px #ff00ffcc;
}
#chatLog::-webkit-scrollbar-track {
  background: transparent;
}

.chat-line {
  margin-bottom: 10px;
  line-height: 1.3;
  padding: 6px 12px;
  border-radius: 8px;
  position: relative;
  transition: background-color 0.4s ease;
  word-break: break-word;
  white-space: pre-wrap;
}

.chat-line.new {
  animation: flash 1.2s ease-out;
  box-shadow: 0 0 15px #ff00ffcc;
}

.chat-line.system {
  color: #ff4444; /* red for system messages */
  font-style: italic;
  background: rgba(255, 0, 0, 0.1);
}

.time {
  color: #aa00ffcc;
  margin-right: 8px;
  text-shadow: 0 0 4px #cc00ff88;
  user-select: none;
  font-weight: 700;
}

.user {
  font-weight: 700;
  margin-right: 8px;
  user-select: none;
}

.discord {
  color: #7289da;
  margin-right: 8px;
  font-weight: 700;
  text-shadow: 0 0 8px #7289daaa;
}

.text {
  color: #ff55ff;
  text-shadow: 0 0 4px #ff00ffbb;
}

@keyframes flash {
  0% { background: rgba(255,0,255,.18); transform: translateY(4px); }
  100% { background: transparent; transform: none; }
}
</style>
</head>

<body>
<div id="chatView">
  <h2>Mirage Online Classic — Global Chat</h2>
  <div id="chatLog">Connecting…</div>
</div>
<script src="intro.js"></script>
<script>
(() => {
  const CHAT_API = 'https://moc.marocodes.eu/api/messages';
  const INTERVAL = 2000;

  const chatLog = document.getElementById('chatLog');
  let lastKey = null;
  let isFetching = false;

  const escapeHtml = v =>
    String(v ?? '').replace(/[&<>"']/g, m =>
      ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])
    );

  // Helper to create a colored span for username
  function userSpan(name, color) {
    const safeName = escapeHtml(name);
    const safeColor = /^#[0-9a-f]{6}$/i.test(color) ? color : '#fff';
    return `<span class="user" style="color: ${safeColor}; text-shadow: 0 0 6px ${safeColor}aa;">${safeName}</span>`;
  }

  function parseTime(rawTime) {
    // Expect "YYYY-MM-DD HH:mm:ss" and convert to "(HH:mm)"
    if (!rawTime) return '';
    const match = rawTime.match(/\d{4}-\d{2}-\d{2} (\d{2}:\d{2}):\d{2}/);
    return match ? `(${match[1]})` : '';
  }

  // Render one line depending on user presence & content type
  function renderLine(line) {
    const timeStr = parseTime(line.time || line.created_at) || '';
    const user = line.user || '';
    const userColor = line.user_color || '#fff';
    const message = line.message || '';
    const raw = line.raw || message;

    // If user is empty => system message or kill message, show entire raw text in red style
    if (!user.trim()) {
      return `<div class="chat-line system">${escapeHtml(raw)}</div>`;
    }

    // Else, show time + colored username + message (raw without username/time)
    // Extract message text after username + colon in raw if possible
    // Otherwise fallback to line.message
    
    // Try to extract message text from raw (after first colon after username)
    const colonPos = raw.indexOf(':');
    let msgText = message;
    if (colonPos !== -1) {
      // message text is everything after colon + space
      msgText = raw.slice(colonPos + 1).trim();
    }

    return `<div class="chat-line">
      <span class="time">${escapeHtml(timeStr)}</span>
      ${userSpan(user, userColor)}:
      <span class="text">${escapeHtml(msgText)}</span>
    </div>`;
  }

  async function fetchChat() {
    if (isFetching) return;
    isFetching = true;

    try {
      const res = await fetch(CHAT_API);
      if (!res.ok) throw new Error('API error');

      const data = await res.json();
      if (Array.isArray(data)) {
        // Reverse to show oldest first (assuming API newest first)
        render(data.slice().reverse());
      }
    } catch (e) {
      console.error(e);
      chatLog.textContent = 'Error loading chat.';
    } finally {
      isFetching = false;
      setTimeout(fetchChat, INTERVAL);
    }
  }

  function render(lines) {
    const newestId = lines.length ? lines[lines.length -1].id : null;
    chatLog.innerHTML = lines.map(line => renderLine(line)).join('');
    lastKey = newestId;
    chatLog.scrollTop = chatLog.scrollHeight;
  }

  fetchChat();
})();
</script>

</body>
</html>
