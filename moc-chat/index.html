<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>MOC Global Chat Viewer</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
  body {
  font-family: 'Press Start 2P', monospace, Arial, sans-serif;
  background: radial-gradient(circle at top left, #12002b, #000000);
  color: #eee;
  margin: 0;
  user-select: none;
}

#chatView {
  max-width: 900px;
  margin: 2em auto;
  padding: 1em;
  background: rgba(30, 0, 50, 0.6);
  border-radius: 12px;
  box-shadow: 0 0 15px #ff00ff88;
  backdrop-filter: blur(8px);
  border: 1px solid #ff00ff55;
}

#chatLog {
  background: rgba(10, 0, 20, 0.8);
  padding: 1em;
  height: 520px;
  overflow-y: auto;
  border-radius: 10px;
  box-shadow: inset 0 0 8px #ff00ff44;
  scrollbar-width: thin;
  scrollbar-color: #ff00ffaa transparent;
  font-size: 14px;
}

#chatLog::-webkit-scrollbar {
  width: 8px;
}
#chatLog::-webkit-scrollbar-thumb {
  background: #ff00ffaa;
  border-radius: 10px;
  box-shadow: 0 0 8px #ff00ffcc;
}
#chatLog::-webkit-scrollbar-track {
  background: transparent;
}

.chat-line {
  margin-bottom: 10px;
  line-height: 1.3;
  padding: 6px 12px;
  border-radius: 8px;
  position: relative;
  transition: background-color 0.4s ease;
}

.chat-line.new {
  animation: flash 1.2s ease-out;
  box-shadow: 0 0 15px #ff00ffcc;
}

.chat-line.system {
  font-style: italic;
  color: #ff77ffcc;
  background: rgba(255, 0, 255, 0.1);
}

.time {
  color: #aa00ffcc;
  margin-right: 8px;
  text-shadow: 0 0 4px #cc00ff88;
  user-select: none;
  font-weight: 700;
}

.user {
  color: #00ff99;
  margin-right: 8px;
  font-weight: 700;
  text-shadow: 0 0 5px #00ffbbaa;
}

.discord {
  color: #7289da;
  margin-right: 8px;
  font-weight: 700;
  text-shadow: 0 0 8px #7289daaa;
}

.text {
  color: #ff55ff;
  text-shadow: 0 0 4px #ff00ffbb;
}

@keyframes flash {
  0% { background: rgba(255,0,255,.18); transform: translateY(4px); }
  100% { background: transparent; transform: none; }
}
</style>
</head>

<body>
<div id="chatView">
  <h2>Mirage Online Classic — Global Chat</h2>
  <div id="chatLog">Connecting…</div>
</div>
<script src="intro.js"></script>
<script>
(() => {
  const CHAT_API = 'https://moc.marocodes.eu/api/messages';
  const API_TOKEN = 'f684f5c2474a579a37e6747e92e3b8a4';
  const INTERVAL = 2000;

  const chatLog = document.getElementById('chatLog');
  let lastKey = null;

  const escapeHtml = v =>
    String(v ?? '').replace(/[&<>"']/g, m =>
      ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])
    );

  function parseLine(raw) {
    // If raw is an object and color is "#00ffff", ignore this message entirely
    if (raw && raw.color && raw.color.toLowerCase() === '#00ffff') {
      return null;  // skip guild messages
    }

    let line =
      typeof raw === 'string'
        ? raw
        : typeof raw?.message === 'string'
          ? raw.message
          : '';

    line = line.trim();
    if (!line) return null;

    // Match Discord messages: (01:36) (Discord) Jupiter: Lol
    let m = line.match(/^\((\d{2}:\d{2})\)\s*\(Discord\)\s*(.+?):\s*(.*)$/);
    if (m) {
      return {
        time: m[1],
        user: m[2],
        text: m[3],
        tag: 'Discord',
        system: false
      };
    }

    // Match normal messages: (01:36) User: message
    m = line.match(/^\((\d{2}:\d{2})\)\s*(.+?):\s*(.*)$/);
    if (m) {
      return {
        time: m[1],
        user: m[2],
        text: m[3],
        tag: null,
        system: false
      };
    }

    // Fallback / system message
    return {
      time: '',
      user: '',
      text: line,
      tag: null,
      system: true
    };
  }

  function keyOf(raw) {
    // Use the raw string or message property as a unique key for new message detection
    if (typeof raw === 'string') return raw;
    if (raw && typeof raw.message === 'string') return raw.message;
    return '';
  }

  async function fetchChat() {
    try {
      const res = await fetch(CHAT_API, {
        headers: { Authorization: `Bearer ${API_TOKEN}` }
      });
      if (!res.ok) throw new Error('API error');

      const data = await res.json();
      if (!Array.isArray(data)) return;

      // Reverse to show oldest first, newest last
      render(data.slice().reverse());
    } catch (e) {
      console.error(e);
      chatLog.textContent = 'Error loading chat.';
    }
  }

  function render(lines) {
    if (!lines.length) {
      chatLog.innerHTML = '<i>No messages yet.</i>';
      return;
    }

    const newestKey = keyOf(lines[lines.length - 1]);

    chatLog.innerHTML = lines.map(raw => {
      const parsed = parseLine(raw);
      if (!parsed) return ''; // skip ignored messages

      const isNew = lastKey && keyOf(raw) === newestKey && newestKey !== lastKey;

      if (parsed.system) {
        return `
          <div class="chat-line ${isNew ? 'new' : ''}">
            <span class="system">${escapeHtml(parsed.text)}</span>
          </div>
        `;
      }

      if (parsed.tag === 'Discord') {
        return `
          <div class="chat-line ${isNew ? 'new' : ''}">
            <span class="time">(${escapeHtml(parsed.time)})</span>
            <span class="discord">(Discord)</span>
            <span class="user">${escapeHtml(parsed.user)}:</span>
            <span class="text">${escapeHtml(parsed.text)}</span>
          </div>
        `;
      }

      return `
        <div class="chat-line ${isNew ? 'new' : ''}">
          <span class="time">(${escapeHtml(parsed.time)})</span>
          <span class="user">${escapeHtml(parsed.user)}:</span>
          <span class="text">${escapeHtml(parsed.text)}</span>
        </div>
      `;
    }).join('');

    lastKey = newestKey;
    chatLog.scrollTop = chatLog.scrollHeight;
  }

  fetchChat();
  setInterval(fetchChat, INTERVAL);

})();
</script>

</body>
</html>
