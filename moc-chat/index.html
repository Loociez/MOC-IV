<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MOC Global Chat Viewer</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  font-family: Arial, sans-serif;
  background: #1a1a1a;
  color: #eee;
  margin: 0;
}

#chatView {
  max-width: 900px;
  margin: 1em auto;
}

#chatLog {
  background: #222;
  padding: 1em;
  height: 520px;
  overflow-y: auto;
  border-radius: 6px;
}

.chat-line {
  margin-bottom: 6px;
  line-height: 1.35;
}

.chat-line.new {
  animation: flash 1.2s ease-out;
}

@keyframes flash {
  0% { background: rgba(255,0,255,.18); transform: translateY(4px); }
  100% { background: transparent; transform: none; }
}

.time { color: #888; margin-right: 4px; }
.user { color: #00ff00; margin-right: 4px; }
.discord { color: #00b7ff; margin-right: 4px; }
.text { color: #ff00ff; }
.system { color: #ff00ff; font-style: italic; }
</style>
</head>

<body>

<div id="chatView">
  <h2>Mirage Online Classic â€” Global Chat</h2>
  <div id="chatLog">Connectingâ€¦</div>
</div>

<script>
(() => {

  const CHAT_API = 'https://moc.marocodes.eu/api/messages';
  const API_TOKEN = 'f684f5c2474a579a37e6747e92e3b8a4';
  const INTERVAL = 2000;

  const chatLog = document.getElementById('chatLog');
  let lastKey = null;

  const escapeHtml = v =>
    String(v ?? '').replace(/[&<>"']/g, m =>
      ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])
    );

  function parseLine(raw) {
    raw = escapeHtml(raw.trim());

    // (01:36) (Discord) Jupiter: Lol
    let discord = raw.match(/^\((\d\d:\d\d)\)\s+\(Discord\)\s+(.+?):\s+(.*)$/);
    if (discord) {
      return {
        time: discord[1],
        tag: 'Discord',
        user: discord[2],
        text: discord[3]
      };
    }

    // (01:36) Loocie ðŸŒ¸: message
    let normal = raw.match(/^\((\d\d:\d\d)\)\s+(.+?):\s+(.*)$/);
    if (normal) {
      return {
        time: normal[1],
        user: normal[2],
        text: normal[3]
      };
    }

    // Fallback
    return { system: raw };
  }

  function keyOf(raw) {
    return raw;
  }

  async function fetchChat() {
    try {
      const res = await fetch(CHAT_API, {
        headers: { Authorization: `Bearer ${API_TOKEN}` }
      });
      if (!res.ok) throw new Error('API error');

      const data = await res.json();
      if (!Array.isArray(data)) return;

      render(data.slice().reverse());
    } catch (e) {
      console.error(e);
    }
  }

  function render(lines) {
    const newestKey = keyOf(lines[lines.length - 1]);

    chatLog.innerHTML = lines.map(raw => {
      const parsed = parseLine(raw);
      const isNew = lastKey && keyOf(raw) === newestKey && newestKey !== lastKey;

      if (parsed.system) {
        return `
          <div class="chat-line ${isNew ? 'new' : ''}">
            <span class="system">${parsed.system}</span>
          </div>
        `;
      }

      if (parsed.tag === 'Discord') {
        return `
          <div class="chat-line ${isNew ? 'new' : ''}">
            <span class="time">(${parsed.time})</span>
            <span class="discord">(Discord)</span>
            <span class="user">${parsed.user}:</span>
            <span class="text">${parsed.text}</span>
          </div>
        `;
      }

      return `
        <div class="chat-line ${isNew ? 'new' : ''}">
          <span class="time">(${parsed.time})</span>
          <span class="user">${parsed.user}:</span>
          <span class="text">${parsed.text}</span>
        </div>
      `;
    }).join('');

    lastKey = newestKey;
    chatLog.scrollTop = chatLog.scrollHeight;
  }

  fetchChat();
  setInterval(fetchChat, INTERVAL);

})();
</script>

</body>
</html>
