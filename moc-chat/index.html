<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>MOC Global Chat Viewer</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
  body {
  font-family: 'Press Start 2P', 'Segoe UI Emoji', 'Noto Color Emoji', monospace, Arial, sans-serif;
  background: radial-gradient(circle at top left, #12002b, #000000);
  color: #eee;
  margin: 0;
  user-select: none;
}

#chatView {
  max-width: 900px;
  margin: 2em auto;
  padding: 1em;
  background: rgba(30, 0, 50, 0.6);
  border-radius: 12px;
  box-shadow: 0 0 15px #ff00ff88;
  backdrop-filter: blur(8px);
  border: 1px solid #ff00ff55;
}

#chatLog {
  background: rgba(10, 0, 20, 0.8);
  padding: 1em;
  height: 520px;
  overflow-y: auto;
  border-radius: 10px;
  box-shadow: inset 0 0 8px #ff00ff44;
  scrollbar-width: thin;
  scrollbar-color: #ff00ffaa transparent;
  font-size: 14px;
  white-space: pre-wrap;
  word-break: break-word;
}

#chatLog::-webkit-scrollbar {
  width: 8px;
}
#chatLog::-webkit-scrollbar-thumb {
  background: #ff00ffaa;
  border-radius: 10px;
  box-shadow: 0 0 8px #ff00ffcc;
}
#chatLog::-webkit-scrollbar-track {
  background: transparent;
}

.chat-line {
  margin-bottom: 10px;
  line-height: 1.3;
  padding: 6px 12px;
  border-radius: 8px;
  position: relative;
  transition: background-color 0.4s ease;
}

.chat-line.new {
  animation: flash 1.2s ease-out;
  box-shadow: 0 0 15px #ff00ffcc;
}

.user-colored {
  font-weight: 700;
  user-select: none;
  text-shadow: 0 0 6px;
}

@keyframes flash {
  0% { background: rgba(255,0,255,.18); transform: translateY(4px); }
  100% { background: transparent; transform: none; }
}
</style>
</head>

<body>
<div id="chatView">
  <h2>Mirage Online Classic — Global Chat</h2>
  <div id="chatLog">Connecting…</div>
</div>
<script src="intro.js"></script>
<script>
(() => {
  const CHAT_API = 'https://moc.marocodes.eu/api/messages';
  const INTERVAL = 2000;

  const chatLog = document.getElementById('chatLog');
  let isFetching = false;

  const escapeHtml = v =>
    String(v ?? '').replace(/[&<>"']/g, m =>
      ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])
    );

  // Colorize username inside raw message, outputting safe HTML string
  function colorizeUsername(raw, user, userColor) {
    const escapedUser = user.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
    // Regex: time + space + username + colon, capture groups for parts
    const regex = new RegExp(`^(\\(\\d{2}:\\d{2}\\) )(${escapedUser})(:)`);

    const match = raw.match(regex);
    if (!match) {
      // no username found, escape whole raw
      return escapeHtml(raw);
    }

    // Now build the final string:
    // match[1] = time with parens and space, match[2] = username, match[3] = colon
    // We escape the raw string parts except the username part which we color inline with a <span>
    const beforeUser = escapeHtml(match[1]);
    const safeColor = /^#[0-9a-f]{6}$/i.test(userColor) ? userColor : '#fff';
    const coloredUser = `<span style="color:${safeColor};">${escapeHtml(match[2])}</span>`;
    const afterUser = escapeHtml(raw.slice(match[1].length + match[2].length));

    return beforeUser + coloredUser + afterUser;
  }

  function renderLine(line) {
    const user = (line.user || '').trim();
    const userColor = line.user_color || '#fff';
    const raw = line.raw || line.message || '';

    // Always color line by user_color (including system messages)
    const safeColor = /^#[0-9a-f]{6}$/i.test(userColor) ? userColor : '#fff';
    const contentHtml = colorizeUsername(raw, user, userColor);

    return `<div class="chat-line" style="color:${safeColor};">${contentHtml}</div>`;
  }

  async function fetchChat() {
    if (isFetching) return;
    isFetching = true;

    try {
      const res = await fetch(CHAT_API);
      if (!res.ok) throw new Error('API error');

      const data = await res.json();
      if (Array.isArray(data)) {
        render(data.slice().reverse());
      }
    } catch (e) {
      console.error(e);
      chatLog.textContent = 'Error loading chat.';
    } finally {
      isFetching = false;
      setTimeout(fetchChat, INTERVAL);
    }
  }

  function render(lines) {
    chatLog.innerHTML = lines.map(line => renderLine(line)).join('');
    chatLog.scrollTop = chatLog.scrollHeight;
  }

  fetchChat();
})();
</script>

</body>
</html>
