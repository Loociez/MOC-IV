<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Build Editor</title>
  <style>
    body {
      background: #2d004d;
      color: gold;
      font-family: Arial, sans-serif;
      padding: 20px;
    }

    h1, h2 {
      color: gold;
    }

    #baseStats label {
      margin-right: 10px;
      display: inline-block;
      margin-bottom: 10px;
    }

    .searchable-slot {
      margin-bottom: 20px;
      position: relative;
    }

    .search-input {
      width: 100%;
      padding: 6px;
      background-color: #4b0082;
      color: gold;
      border: 1px solid gold;
    }

    .dropdown-list {
      position: absolute;
      background-color: #4b0082;
      color: gold;
      list-style: none;
      margin: 0;
      padding: 0;
      border: 1px solid gold;
      width: 100%;
      max-height: 150px;
      overflow-y: auto;
      display: none;
      z-index: 5;
    }

    .dropdown-list li {
      padding: 5px;
      cursor: pointer;
    }

    .dropdown-list li:hover {
      background-color: #6a0dad;
    }

    .stats {
      background: #4b0082;
      padding: 15px;
      border: 1px solid gold;
      white-space: pre-line;
    }
  </style>
</head>
<body>
  <h1>Build Editor</h1>
  <br>
 <h3>Side note: Currently all items can be selected for each item slot, so be aware when currently selecting builds.</h3>
  <h2>Base Stats</h2>
  <div id="baseStats">
    <label>HP: <input type="number" id="base_hp" value="0"></label>
    <label>MP: <input type="number" id="base_mp" value="0"></label>
    <label>SP: <input type="number" id="base_sp" value="0"></label><br>
    <label>PATK: <input type="number" id="base_patk" value="0"></label>
    <label>PDEF: <input type="number" id="base_pdef" value="0"></label><br>
    <label>RATK: <input type="number" id="base_ratk" value="0"></label>
    <label>RDEF: <input type="number" id="base_rdef" value="0"></label><br>
    <label>MATK: <input type="number" id="base_matk" value="0"></label>
    <label>MDEF: <input type="number" id="base_mdef" value="0"></label>
  </div>

  <h2>Equipment</h2>

  <div class="searchable-slot" data-slot="helm">
    <label>Helm:</label>
    <input type="text" class="search-input" placeholder="Search helm..." oninput="filterDropdown(this)">
    <ul class="dropdown-list"></ul>
    <input type="hidden" class="selected-value">
  </div>

  <div class="searchable-slot" data-slot="armor">
    <label>Armor:</label>
    <input type="text" class="search-input" placeholder="Search armor..." oninput="filterDropdown(this)">
    <ul class="dropdown-list"></ul>
    <input type="hidden" class="selected-value">
  </div>

  <div class="searchable-slot" data-slot="weapon">
    <label>Weapon:</label>
    <input type="text" class="search-input" placeholder="Search weapon..." oninput="filterDropdown(this)">
    <ul class="dropdown-list"></ul>
    <input type="hidden" class="selected-value">
  </div>

  <div class="searchable-slot" data-slot="shield">
    <label>Shield:</label>
    <input type="text" class="search-input" placeholder="Search shield..." oninput="filterDropdown(this)">
    <ul class="dropdown-list"></ul>
    <input type="hidden" class="selected-value">
  </div>

  <div class="searchable-slot" data-slot="accessory">
    <label>Accessory:</label>
    <input type="text" class="search-input" placeholder="Search accessory..." oninput="filterDropdown(this)">
    <ul class="dropdown-list"></ul>
    <input type="hidden" class="selected-value">
  </div>

  <h2>Total Stats</h2>
  <div class="stats" id="totalStats">No items equipped.</div>

  <script>
    let allItems = [];

    async function loadItems() {
      try {
        const response = await fetch('last.json');
        allItems = await response.json();

        // Populate dropdowns for all slots without filtering (allow all items)
        populateSearchDropdown('helm', () => true);
        populateSearchDropdown('armor', () => true);
        populateSearchDropdown('weapon', () => true);
        populateSearchDropdown('shield', () => true);
        populateSearchDropdown('accessory', () => true);

        // Update stats on base stat inputs change
        document.querySelectorAll('#baseStats input').forEach(input => {
          input.addEventListener('input', updateStats);
        });

        updateStats();

      } catch (e) {
        console.error('Failed to load last.json:', e);
        document.getElementById('totalStats').textContent = 'Failed to load items.';
      }
    }

    // Track active dropdown so only one outside click listener is added
    let activeDropdown = null;

    function populateSearchDropdown(slot, filterFn) {
      const slotDiv = document.querySelector(`.searchable-slot[data-slot="${slot}"]`);
      const list = slotDiv.querySelector('.dropdown-list');
      list.innerHTML = '';

      const filteredItems = allItems.filter(filterFn);
      filteredItems.forEach(item => {
        const li = document.createElement('li');
        li.textContent = item.name;
        li.onclick = () => {
          slotDiv.querySelector('.search-input').value = item.name;
          slotDiv.querySelector('.selected-value').value = item.name;
          list.style.display = 'none';
          updateStats();
        };
        list.appendChild(li);
      });

      // Show dropdown on focus
      const input = slotDiv.querySelector('.search-input');
      input.addEventListener('focus', () => {
        list.style.display = 'block';
        activeDropdown = list;
      });

      // Add one global click listener to close dropdown if clicked outside
      if (!document._dropdownListenerAdded) {
        document.addEventListener('click', (e) => {
          if (activeDropdown && !activeDropdown.parentElement.contains(e.target)) {
            activeDropdown.style.display = 'none';
            activeDropdown = null;
          }
        });
        document._dropdownListenerAdded = true;
      }
    }

    function filterDropdown(input) {
      const slotDiv = input.closest('.searchable-slot');
      const list = slotDiv.querySelector('.dropdown-list');
      const filter = input.value.toLowerCase();
      const items = list.querySelectorAll('li');

      let anyVisible = false;
      items.forEach(item => {
        const match = item.textContent.toLowerCase().includes(filter);
        item.style.display = match ? 'block' : 'none';
        if (match) anyVisible = true;
      });

      list.style.display = anyVisible ? 'block' : 'none';
    }

    function updateStats() {
      const slots = ['helm', 'armor', 'weapon', 'shield', 'accessory'];
      let combinedStats = {};

      // Add equipped item stats
      slots.forEach(slot => {
        const selectedName = document.querySelector(`.searchable-slot[data-slot="${slot}"] .selected-value`).value;
        if (!selectedName) return;

        const item = allItems.find(i => i.name === selectedName);
        if (!item || !item.data) return;

        for (let [key, val] of Object.entries(item.data)) {
          if (typeof val !== 'number') continue;

          let normalizedKey = key;

          if (key.startsWith('max_')) {
            normalizedKey = key.slice(4);
          } else if (key.startsWith('min_')) {
            const minMap = {
              min_atk: 'patk',
              min_def: 'pdef',
              min_mat: 'matk',
              min_mdf: 'mdef',
              min_rat: 'ratk',
              min_rdf: 'rdef'
            };
            normalizedKey = minMap[key] || key.slice(4);
          }

          combinedStats[normalizedKey] = (combinedStats[normalizedKey] || 0) + val;
        }

        if (item.tile_range) {
          combinedStats['tile_range'] = (combinedStats['tile_range'] || 0) + item.tile_range;
        }
      });

      // Add base stats
      const baseKeys = ['hp', 'mp', 'sp', 'patk', 'pdef', 'ratk', 'rdef', 'matk', 'mdef'];
      baseKeys.forEach(key => {
        const val = parseInt(document.getElementById(`base_${key}`).value) || 0;
        combinedStats[key] = (combinedStats[key] || 0) + val;
      });

      if (Object.keys(combinedStats).length === 0) {
        document.getElementById('totalStats').textContent = 'No items equipped.';
      } else {
        const statText = Object.entries(combinedStats)
          .map(([k, v]) => `${k.toUpperCase().replace(/_/g, ' ')}: ${v}`)
          .join('\n');
        document.getElementById('totalStats').textContent = statText;
      }
    }

    window.addEventListener('DOMContentLoaded', loadItems);
  </script>
</body>
</html>
