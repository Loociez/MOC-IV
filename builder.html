<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Build Editor</title>
  <style>
    body {
      background: #2d004d;
      color: gold;
      font-family: Arial, sans-serif;
      padding: 20px;
    }

    h1, h2 {
      color: gold;
    }

    #baseStats label {
      margin-right: 10px;
      display: inline-block;
      margin-bottom: 10px;
    }

    .searchable-slot {
      margin-bottom: 20px;
      position: relative;
    }

    .search-input {
      width: 100%;
      padding: 6px;
      background-color: #4b0082;
      color: gold;
      border: 1px solid gold;
    }

    .dropdown-list {
      position: absolute;
      background-color: #4b0082;
      color: gold;
      list-style: none;
      margin: 0;
      padding: 0;
      border: 1px solid gold;
      width: 100%;
      max-height: 150px;
      overflow-y: auto;
      display: none;
      z-index: 5;
    }

    .dropdown-list li {
      padding: 5px;
      cursor: pointer;
    }

    .dropdown-list li:hover {
      background-color: #6a0dad;
    }

    .stats {
      background: #4b0082;
      padding: 15px;
      border: 1px solid gold;
      white-space: pre-line;
    }
  </style>
</head>
<body>
  <h1>Build Editor</h1>

  <h2>Load Item Data</h2>
  <input type="file" id="itemFile" accept=".json" onchange="loadItemData(this)">

  <h2>Base Stats</h2>
  <div id="baseStats">
    <label>HP: <input type="number" id="base_hp" value="0"></label>
    <label>MP: <input type="number" id="base_mp" value="0"></label>
    <label>SP: <input type="number" id="base_sp" value="0"></label><br>
    <label>PATK: <input type="number" id="base_patk" value="0"></label>
    <label>PDEF: <input type="number" id="base_pdef" value="0"></label><br>
    <label>RATK: <input type="number" id="base_ratk" value="0"></label>
    <label>RDEF: <input type="number" id="base_rdef" value="0"></label><br>
    <label>MATK: <input type="number" id="base_matk" value="0"></label>
    <label>MDEF: <input type="number" id="base_mdef" value="0"></label>
  </div>

  <h2>Equipment</h2>
  <div id="equipmentSlots"></div>

  <h2>Total Stats</h2>
  <div class="stats" id="totalStats">No items equipped.</div>
  <h2>Save / Load Build</h2>
<button onclick="saveBuild()">Save Build</button>
<input type="file" id="loadBuildFile" accept=".json" onchange="loadBuild(this)">


  <h2>NPC Damage Simulator</h2>
  <div>
    <label>Load NPC Data:
      <input type="file" id="npcFile" accept=".json" onchange="loadNPCData(this)">
    </label>
  </div>

  <div id="npcSimSection" style="display:none; margin-top: 10px;">
    <label for="npcSelect">Select NPC:</label>
    <select id="npcSelect" onchange="simulateDamage()"></select>
  </div>

  <div class="stats" id="damageOutput">No NPC selected.</div>

  <script>
    let allItems = [], npcData = [];
    const slots = ['helm', 'armor', 'weapon', 'shield', 'accessory'];

    function loadItemData(input) {
      const reader = new FileReader();
      reader.onload = e => {
        try {
          allItems = JSON.parse(e.target.result);
          setupEquipmentSlots();
        } catch (err) {
          alert("Invalid item data");
        }
      };
      reader.readAsText(input.files[0]);
    }

    function setupEquipmentSlots() {
      const container = document.getElementById('equipmentSlots');
      container.innerHTML = '';
      slots.forEach(slot => {
        const div = document.createElement('div');
        div.className = 'searchable-slot';
        div.dataset.slot = slot;
        div.innerHTML = `
          <label>${slot.charAt(0).toUpperCase() + slot.slice(1)}:</label>
          <input type="text" class="search-input" placeholder="Search ${slot}..." oninput="filterDropdown(this)">
          <ul class="dropdown-list"></ul>
          <input type="hidden" class="selected-value">
        `;
        container.appendChild(div);
        populateSearchDropdown(slot);
      });

      document.querySelectorAll('#baseStats input').forEach(input => {
        input.addEventListener('input', () => {
          updateStats();
          simulateDamage();
        });
      });
    }

    function populateSearchDropdown(slot) {
      const slotDiv = document.querySelector(`.searchable-slot[data-slot="${slot}"]`);
      const list = slotDiv.querySelector('.dropdown-list');
      list.innerHTML = '';

      allItems.forEach(item => {
        const li = document.createElement('li');
        li.textContent = item.name;
        li.onclick = () => {
          slotDiv.querySelector('.search-input').value = item.name;
          slotDiv.querySelector('.selected-value').value = item.name;
          list.style.display = 'none';
          updateStats();
          simulateDamage();
        };
        list.appendChild(li);
      });

      slotDiv.querySelector('.search-input').addEventListener('focus', () => {
        list.style.display = 'block';
      });

      document.addEventListener('click', e => {
        if (!slotDiv.contains(e.target)) list.style.display = 'none';
      });
    }

    function filterDropdown(input) {
      const slotDiv = input.closest('.searchable-slot');
      const list = slotDiv.querySelector('.dropdown-list');
      const filter = input.value.toLowerCase();
      list.querySelectorAll('li').forEach(item => {
        item.style.display = item.textContent.toLowerCase().includes(filter) ? 'block' : 'none';
      });
    }

    function updateStats() {
      const stats = getCombinedStats();
      document.getElementById('totalStats').textContent = Object.keys(stats).length === 0 ? 'No items equipped.' :
        Object.entries(stats).map(([k, v]) => `${k.toUpperCase()}: ${v}`).join('\n');
    }

    function getCombinedStats() {
      const baseStats = ['hp', 'mp', 'sp', 'patk', 'pdef', 'ratk', 'rdef', 'matk', 'mdef'];
      const stats = {};

      baseStats.forEach(key => {
        stats[key] = parseInt(document.getElementById(`base_${key}`).value) || 0;
      });

      slots.forEach(slot => {
        const selected = document.querySelector(`.searchable-slot[data-slot="${slot}"] .selected-value`).value;
        const item = allItems.find(i => i.name === selected);
        if (!item || !item.data) return;

        Object.entries(item.data).forEach(([key, val]) => {
          if (typeof val !== 'number') return;

          const minMap = {
            min_atk: 'patk', min_def: 'pdef', min_mat: 'matk',
            min_mdf: 'mdef', min_rat: 'ratk', min_rdf: 'rdef'
          };

          let normKey = key.startsWith('max_') ? key.slice(4) : minMap[key] || key;
          if (!baseStats.includes(normKey)) return;

          stats[normKey] = (stats[normKey] || 0) + val;
        });
      });

      return stats;
    }

    function loadNPCData(input) {
      const reader = new FileReader();
      reader.onload = e => {
        try {
          npcData = JSON.parse(e.target.result);
          populateNPCDropdown();
          document.getElementById('npcSimSection').style.display = 'block';
        } catch (err) {
          alert("Invalid NPC data");
        }
      };
      reader.readAsText(input.files[0]);
    }

    function populateNPCDropdown() {
      const select = document.getElementById('npcSelect');
      select.innerHTML = '<option value="">-- Select NPC --</option>';
      npcData.forEach((npc, i) => {
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = npc.name || `NPC ${i+1}`;
        select.appendChild(opt);
      });
    }

    function simulateDamage() {
      const index = document.getElementById('npcSelect').value;
      if (index === '') return document.getElementById('damageOutput').textContent = 'No NPC selected.';

      const npc = npcData[index];
      const s = getCombinedStats();

      const dmg = (atk, def) => Math.max(0, (s[atk] || 0) - (npc[def] || 0));

      document.getElementById('damageOutput').textContent =
        `Against ${npc.name || 'Unknown'}:\n` +
        `PHYSICAL DMG: ${dmg('patk', 'pdef')}\n` +
        `RANGED DMG: ${dmg('ratk', 'rdef')}\n` +
        `MAGIC DMG: ${dmg('matk', 'mdef')}`;
    }
	function saveBuild() {
  const build = {
    baseStats: {},
    equipment: {}
  };

  // Gather base stats
  document.querySelectorAll('#baseStats input').forEach(input => {
    build.baseStats[input.id] = input.value;
  });

  // Gather equipment selections
  slots.forEach(slot => {
    const selected = document.querySelector(`.searchable-slot[data-slot="${slot}"] .selected-value`).value;
    build.equipment[slot] = selected;
  });

  const blob = new Blob([JSON.stringify(build, null, 2)], { type: "application/json" });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = "build.json";
  link.click();
}

function loadBuild(input) {
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const build = JSON.parse(e.target.result);

      // Set base stats
      for (const id in build.baseStats) {
        const el = document.getElementById(id);
        if (el) el.value = build.baseStats[id];
      }

      // Set equipment
      for (const slot in build.equipment) {
        const slotDiv = document.querySelector(`.searchable-slot[data-slot="${slot}"]`);
        const name = build.equipment[slot];
        if (!slotDiv) continue;

        const input = slotDiv.querySelector('.search-input');
        const hidden = slotDiv.querySelector('.selected-value');
        const item = allItems.find(i => i.name === name);

        if (item) {
          input.value = name;
          hidden.value = name;
        } else {
          input.value = '';
          hidden.value = '';
        }
      }

      updateStats();
      simulateDamage();
    } catch (err) {
      alert("Invalid build file");
    }
  };
  reader.readAsText(input.files[0]);
}

  </script>
</body>
</html>
