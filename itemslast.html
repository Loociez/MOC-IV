<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Item Table View</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: purple;
      color: gold;
      margin: 0;
      padding: 0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
      background-color: #4b0082;
      color: gold;
    }
    th,
    td {
      border: 1px solid gold;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #6a0dad;
    }
    tr:nth-child(even) {
      background-color: #5a0088;
    }
    .data {
      font-size: 0.9em;
      color: #eee;
      white-space: pre-line;
    }
    #searchBar {
      margin: 20px auto;
      display: block;
      width: 90%;
      padding: 10px;
      font-size: 1em;
      border: 1px solid gold;
      border-radius: 4px;
      background-color: #4b0082;
      color: gold;
    }
    #searchBar::placeholder {
      color: gold;
    }
    h1 {
      text-align: center;
      margin: 20px 0;
      color: gold;
    }
    select {
      background-color: #4b0082;
      color: gold;
      border: 1px solid gold;
    }
  </style>
</head>
<body>
  <h1 id="itemListHeading">Last Known 07/04/25 - Item List</h1>
  <select id="languageSelector" onchange="changeLanguage(this.value)">
    <option value="en">English</option>
    <option value="es">Espa√±ol</option>
  </select>

  <input
    type="text"
    id="searchBar"
    placeholder="Search for an item..."
    oninput="filterTable()"
  />
  <label style="margin-left: 10px;" id="weaponFilterLabel"
    ><input type="checkbox" id="weaponFilter" onclick="filterTable()" />
    Weapons Only</label
  >
  <label style="margin-left: 10px;" id="petFilterLabel"
    ><input type="checkbox" id="petFilter" onclick="filterTable()" /> Pets
    Only</label
  >
  <label style="margin-left: 10px;" id="recipeFilterLabel"
    ><input type="checkbox" id="recipeFilter" onclick="filterTable()" /> Recipes
    Only</label
  >
  <label style="margin-left: 10px;" id="rareFilterLabel"
    ><input type="checkbox" id="rareFilter" onclick="filterTable()" /> Rare+</label
  >
  <label style="margin-left: 10px;" id="favoritesFilterLabel"
    ><input
      type="checkbox"
      id="favoritesFilter"
      onclick="filterTable()"
    /> Show Favorites Only</label
  >

  <label for="sortStat" style="margin-left: 10px;">Sort by:</label>
  <select id="sortStat" onchange="filterTable()">
    <option value="">-- None --</option>
    <option value="max_atk">Max Physical Attack</option>
    <option value="max_mat">Max Magical Attack</option>
    <option value="max_hp">Max HP</option>
    <option value="max_def">Max Defense</option>
    <option value="max_mdf">Max M. Defense</option>
    <option value="max_rat">Max Ranged Attack</option>
    <option value="max_rdf">Max Ranged Defense</option>
  </select>

  <button onclick="clearComparison()">Clear Comparison</button>
  <button onclick="clearFavorites()">Clear Favorites</button>
  <button onclick="generateShareLink()">Share Comparison</button>
  <button onclick="copyStats()">Copy Stats</button>
  <button onclick="copyDescription()">Copy Description</button>

  <table id="itemTable">
    <thead>
      <tr>
        <th>Select</th>
        <th>Name</th>
        <th>Description</th>
        <th>Stats</th>
        <th>Repair Cost</th>
        <th>Uses</th>
        <th>Sell Value</th>
        <th>Handedness</th>
        <th>Fav's</th>
      </tr>
    </thead>
    <tbody>
      <!-- Rows populated dynamically -->
    </tbody>
  </table>

 <script>
let selectedItems = [];

async function fetchItemData() {
    try {
        const response = await fetch('last.json');
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
        const data = await response.json();
        return data;
    } catch (error) {
        console.error('Failed to fetch item data:', error);
    }
}

function isFavorite(name) {
    return localStorage.getItem(`fav-${name}`) === 'true';
}

function toggleFavorite(item) {
    const key = `fav-${item.name}`;
    const current = localStorage.getItem(key) === 'true';
    localStorage.setItem(key, !current);
    filterTable(); // Refresh filtering
}

function handleItemSelection(item, checkbox) {
    if (checkbox.checked) {
        selectedItems.push(item);
    } else {
        selectedItems = selectedItems.filter(selectedItem => selectedItem.name !== item.name);
    }

    if (selectedItems.length === 2) {
        displayComparison(selectedItems);
    } else {
        document.getElementById('comparisonModal').style.display = 'none';
    }
}

function displayComparison(selectedItems) {
    const [item1, item2] = selectedItems;
    const comparisonTableBody = document.getElementById('comparisonTable').querySelector('tbody');
    comparisonTableBody.innerHTML = '';

    const row = document.createElement('tr');

    const nameCell = document.createElement('td');
    nameCell.textContent = `${item1.name} vs ${item2.name}`;
    row.appendChild(nameCell);

    const statsCell1 = document.createElement('td');
    const statsCell2 = document.createElement('td');

    const stats1 = item1.data || {};
    const stats2 = item2.data || {};
    const excludedFields = ["brightness", "sprite", "sprite_rotation", "saturation", "hue", "alpha", "spin"];

    Object.entries(stats1).forEach(([key, value]) => {
        if (excludedFields.includes(key)) return;
        const span = document.createElement('span');
        span.textContent = `${key}: ${value}`;
        statsCell1.appendChild(span);
        statsCell1.appendChild(document.createElement('br'));
    });

    Object.entries(stats2).forEach(([key, value]) => {
        if (excludedFields.includes(key)) return;
        const span = document.createElement('span');
        span.textContent = `${key}: ${value}`;
        statsCell2.appendChild(span);
        statsCell2.appendChild(document.createElement('br'));
    });

    row.appendChild(statsCell1);
    row.appendChild(statsCell2);

    comparisonTableBody.appendChild(row);
    document.getElementById('comparisonModal').style.display = 'block';
}

function clearComparison() {
    selectedItems = [];
    document.querySelectorAll('#itemTable input[type="checkbox"]').forEach(cb => cb.checked = false);
    document.getElementById('comparisonModal').style.display = 'none';
}

function closeModal() {
    document.getElementById('comparisonModal').style.display = 'none';
}

async function fetchAndDisplayItems() {
    const items = await fetchItemData();
    if (!items) return;

    const tableBody = document.getElementById('itemTable').querySelector('tbody');
    tableBody.innerHTML = '';

    items.forEach(item => {
        const row = document.createElement('tr');

        const selectCell = document.createElement('td');
        const selectCheckbox = document.createElement('input');
        selectCheckbox.type = 'checkbox';
        selectCheckbox.value = item.name;
        selectCheckbox.onclick = () => handleItemSelection(item, selectCheckbox);
        selectCell.appendChild(selectCheckbox);
        row.appendChild(selectCell);

        const nameCell = document.createElement('td');
        nameCell.textContent = item.name;
        row.appendChild(nameCell);

        const descCell = document.createElement('td');
        descCell.textContent = item.desc || 'No description';
        row.appendChild(descCell);

        const dataCell = document.createElement('td');
        const stats = item.data ? Object.entries(item.data) : [];
        const groupedStats = {};
        stats.forEach(([key, value]) => {
            const match = key.match(/^(min|max)_(.+)$/);
            if (match) {
                const [, bound, statName] = match;
                if (!groupedStats[statName]) groupedStats[statName] = {};
                groupedStats[statName][bound] = value;
            } else {
                groupedStats[key] = value;
            }
        });

        const formattedStats = Object.entries(groupedStats).map(([key, val]) => {
            if (typeof val === 'object') {
                return `${key}: ${val.min || '?'} - ${val.max || '?'}`;
            }
            return `${key.replace(/_/g, ' ')}: ${val}`;
        }).join('\n');

        dataCell.textContent = formattedStats || 'No stats';
        row.appendChild(dataCell);

        const repairCostCell = document.createElement('td');
        repairCostCell.textContent = item.repair_cost || 'No repair cost';
        row.appendChild(repairCostCell);

        const usesCell = document.createElement('td');
        usesCell.textContent = item.uses || 'No uses data';
        row.appendChild(usesCell);

        const sellValueCell = document.createElement('td');
        sellValueCell.textContent = item.recycle_value || 'No sell value';
        row.appendChild(sellValueCell);

        const handednessCell = document.createElement('td');
        const isTwoHanded = item.data?.two_handed === true || item.data?.two_handed === 'true';
        handednessCell.textContent = isTwoHanded ? 'Two Handed' : 'One Handed';
        row.appendChild(handednessCell);

        const favoriteCell = document.createElement('td');
        const favoriteCheckbox = document.createElement('input');
        favoriteCheckbox.type = 'checkbox';
        favoriteCheckbox.checked = isFavorite(item.name);
        favoriteCheckbox.onclick = () => toggleFavorite(item);
        favoriteCell.appendChild(favoriteCheckbox);
        row.appendChild(favoriteCell);

        tableBody.appendChild(row);
    });

    filterTable();
}

function filterTable() {
    const searchTerm = document.getElementById('searchBar')?.value?.toLowerCase() || '';
    const weaponFilter = document.getElementById('weaponFilter')?.checked;
    const petFilter = document.getElementById('petFilter')?.checked;
    const recipeFilter = document.getElementById('recipeFilter')?.checked;
    const rareFilter = document.getElementById('rareFilter')?.checked;
    const favoritesFilter = document.getElementById('favoritesFilter')?.checked;

    const rows = document.querySelectorAll('#itemTable tbody tr');
    rows.forEach(row => {
        const nameCell = row.querySelector('td:nth-child(2)');
        const descCell = row.querySelector('td:nth-child(3)');
        const statsCell = row.querySelector('td:nth-child(4)');

        const matchesSearch = nameCell?.textContent.toLowerCase().includes(searchTerm) ||
                              descCell?.textContent.toLowerCase().includes(searchTerm);

        const matchesWeapon = !weaponFilter || statsCell?.textContent.toLowerCase().includes('two handed');
        const matchesPet = !petFilter || nameCell?.textContent.includes('üê∂');
        const matchesRecipe = !recipeFilter || nameCell?.textContent.toLowerCase().includes('recipe') || descCell?.textContent.toLowerCase().includes('recipe');
        const matchesRare = !rareFilter || nameCell?.textContent.includes('*') || descCell?.textContent.includes('*');

        const isFav = isFavorite(nameCell?.textContent);

        const visible = matchesSearch && matchesWeapon && matchesPet && matchesRecipe && matchesRare && (!favoritesFilter || isFav);
        row.style.display = visible ? '' : 'none';
    });
}

document.addEventListener('DOMContentLoaded', fetchAndDisplayItems);
</script>

</body>
</html>
